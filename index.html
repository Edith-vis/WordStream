<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>WordStream</title>
    <script src="./lib/d3.min.js"></script>
    <script src="./lib/d3.layout.wordstream.js"></script>
    <script src="./test/testutil.js"></script>
</head>
<body>
    <script>
        var url = "./data/emptywheel.csv";
        var topics = [];
        d3.csv(url, function(error, rawData) {
            if (error) throw error;
            var inputFormat = d3.time.format('%Y-%m-%dT%H:%M:%S');
            var outputFormat = d3.time.format('%b %Y');
            topics = d3.keys(rawData[0]).slice(2, 6);
            //Filter and take only dates in 2013
            rawData = rawData.filter(function(d){
                var time = inputFormat.parse(d.time);
                var starDate =  inputFormat.parse('2013-01-01T00:00:00');
                var endDate = inputFormat.parse('2014-01-01T00:00:00');
                return      time  >= starDate && time < endDate; 
            });
            var data = {};
            d3.map(rawData, function(d, i){
                var date = inputFormat.parse(d.time);
                var date = outputFormat(date);
                topics.forEach(topic => {
                    if(!data[date]) data[date] = {};
                    data[date][topic] += data[date][topic] ? ('|' +d[topic]): (d[topic]); 
                });
            });
            var data = d3.keys(data).map(function(date, i){
                var words = {};
                topics.forEach(topic => {
                    var raw = {};
                    raw[topic] = data[date][topic].split('|');
                    //Count word frequencies
                    var counts = raw[topic].reduce(function(obj, word){
                        if(!obj[word]){
                            obj[word] = 0;
                        }
                        obj[word]++;
                        return obj;
                    }, {});
                    //Convert to array of objects
                    words[topic] = d3.keys(counts).map(function(d){
                        return{
                            text: d,
                            frequency: counts[d],
                            topic: topic
                        }
                    }).sort(function(a, b){//sort the terms by frequency
                        return b.frequency-a.frequency;
                    }).filter(function(d){return d.text; })//filter out empty words
                    .slice(0, 20);
                });
                return {
                    date: date,
                    words: words
                }
            }).sort(function(a, b){//sort by date
                return outputFormat.parse(a.date) - outputFormat.parse(b.date);
            });
            draw(data);
        });
        // var data = getDummyData();
        // draw(data);
        function draw(data){
            //Layout data
            var width = 1200, height = 400;
            var interpolation = "cardinal";
            var axisPadding = 10;
            var margins = {left: 20, top: 20, right: 10, bottom: 30};
            var ws = d3.layout.wordStream()
            .size([width, height])
            .interpolate(interpolation)
            .data(data);
            var boxes = ws.boxes();
            
            //Display data
            var legendFontSize = 12;
            var legendHeight = boxes.topics.length*legendFontSize;
            var area = d3.svg.area()
            .interpolate(interpolation)
            .x(function(d){return (d.x);})
            .y0(function(d){return d.y0;})
            .y1(function(d){return (d.y0 + d.y); });
            var color = d3.scale.category10();
            var svg = d3.select("body").append('svg').attr({
                width: width + margins.left + margins.top,
                height: height + margins.top + margins.bottom + axisPadding + legendHeight,
            });
            //Display time axes
            var dates = [];
            boxes.data.forEach(row =>{
                dates.push(row.date);
            });
            
            var xAxisScale = d3.scale.ordinal().domain(dates).rangeBands([0, width]);
            var xAxis = d3.svg.axis().orient('bottom').scale(xAxisScale);
            var axisGroup = svg.append('g').attr('transform', 'translate(' + (margins.left) + ',' + (height+margins.top+axisPadding+legendHeight) + ')');
            var axisNodes = axisGroup.call(xAxis);
            styleAxis(axisNodes);
            //Display the vertical gridline
            var xGridlineScale = d3.scale.ordinal().domain(d3.range(0, dates.length+1)).rangeBands([0, width+width/boxes.data.length]);
            var xGridlinesAxis = d3.svg.axis().orient('bottom').scale(xGridlineScale);
            var xGridlinesGroup = svg.append('g').attr('transform', 'translate(' + (margins.left-width/boxes.data.length/2) + ',' + (height+margins.top + axisPadding+legendHeight) + ')');
            var gridlineNodes = xGridlinesGroup.call(xGridlinesAxis.tickSize(-height-axisPadding-legendHeight, 0, 0).tickFormat(''));
            styleGridlineNodes(gridlineNodes);
            //Main group
            var mainGroup = svg.append('g').attr('transform', 'translate(' + margins.left + ',' + margins.top + ')');
            mainGroup.selectAll('path')
                .data(boxes.layers)
                .enter()
                .append('path')
                .attr('d', area)
                .style('fill', function (d, i) {
                    return color(i);
                })
                .attr({
                    'fill-opacity': 0.1,
                    stroke: 'black',
                    'stroke-width': 0.3
                }); 
            var allWords = [];
            d3.map(boxes.data, function(row){
                boxes.topics.forEach(topic=>{
                    allWords = allWords.concat(row.words[topic]);
                });
            });
            allWords = allWords.filter(d=> d.placed==true);//Filter out not placable words
            
            //Display text
            var topics = boxes.topics;
            var c20 = d3.scale.category20b();
            //Color based on the topic
            var topicColorMap = d3.scale.ordinal().domain(topics).range(c20.range());
            //Color based on term
            var terms = [];
            for(i=0; i< allWords.length; i++){
                terms.concat(allWords[i].text);
            }
            var uniqueTerms = d3.set(terms).values();
            var termColorMap = d3.scale.ordinal()
                .domain(uniqueTerms)
                .range(c20.range());

            mainGroup.selectAll('g').data(allWords).enter().append('g')
            .attr({
                transform: function(d){return 'translate('+d.x+', '+d.y+')rotate('+d.rotate+')';}
            }).append('text')
            .text(function(d){return d.text;})
            .attr({
                'font-family': 'Impact',
                'font-size': function(d){return d.fontSize;},
                //fill: function(d){return topicColorMap(d.topic);},
                //fill: function(d, i){return color(i);},
                fill: function(d, i){return termColorMap(d.text);},
                'text-anchor': 'middle',
                'alignment-baseline': 'middle'
            });
            //Build the legends
            var legendGroup = svg.append('g').attr('transform', 'translate(' + margins.left + ',' + (height+margins.top) + ')');
            var legendNodes = legendGroup.selectAll('g').data(boxes.topics).enter().append('g')
            .attr('transform', function(d, i){return 'translate(' + 10 + ',' + (i*legendFontSize) + ')';});
            legendNodes.append('circle').attr({
                r: 5,
                fill: function(d, i){return color(i);},
                'fill-opacity': 0.1,
                stroke: 'black',
                'stroke-width': .5,
            });
            legendNodes.append('text').text(function(d){return d;}).attr({
                'font-size': legendFontSize,
                'alignment-baseline': 'middle',
                dx: 8
            });
        };
        function styleAxis(axisNodes){
            axisNodes.selectAll('.domain').attr({
                fill: 'none',
                'stroke-width': 1,
                stroke: 'black'
            });
            axisNodes.selectAll('.tick line').attr({
                fill: 'none',
                'stroke-width': 1,
                stroke: 'black'
            });
        }
        function styleGridlineNodes(gridlineNodes){
            gridlineNodes.selectAll('.domain').attr({
                fill: 'none',
                stroke: 'none'
            });
            gridlineNodes.selectAll('.tick line').attr({
                fill: 'none',
                'stroke-width': 0.7,
                stroke: 'lightgray'
            });
        }
    </script>
</body>
</html>